<!DOCTYPE html>
<html lang="fr">
    <head>
        <style>
            #popup{
                display: none;
            }
        </style>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script>
            var numJoueur = -1;
            var couleurs=["red","blue"];

            var socket = io();
            function test() {
                console.log("J'appelle le serveur");
                socket.emit('test', "Ô serveur, je t'envoie ce message");
            }
            socket.on('test', data => {
                console.log('Réponse du serveur');
                console.dir(data);
            });
            
            function demandeJoueurs(){
                console.log('Demande des joueurs');
                socket.emit('joueursS');
            }
            socket.on('joueursC', nomsJoueurs => {
                console.log("jouerus reçus du serveur : ");
                console.dir(nomsJoueurs); //console de l'ordi
                $("#listeJoueurs").text(nomsJoueurs);
            });

            function reset(){
                socket.emit('resetS');
                numJoueur = -1;
                $("#listeJoueurs").text("");
            }
            $('#reset').on('click', reset);

            socket.on('switchNum', data =>{
                console.log("changmenet "+data);
                numJoueur=data;
            });
            
            function softreset(){
                document.getElementById("popup").style.display = "none";
                genereDamier(20, 11, 11);
                io.emit('softresetS');
            }

            function cacher(){
                document.getElementById("popup").style.display = "none";
            }

            socket.on('choixContinu', data=>{
                console.dir("popup");
                document.getElementById("popup").style.display = "block";
            });

            function entrerDansLaPartie(){
                let nom = document.getElementById("nom").value;
                console.log("Entré de "+ nom);
                if(nom != "" && nom != " "){                   // T:Pourquoi ce if? V: car on vérif si le nom c'est pas vide, ou juste un espace
                    console.log("   emission de "+ nom);
                    socket.emit('entreeS', nom);
                }
            }
            function quitterLaPartie(){
                let nom = document.getElementById("nom").value;
                console.log("Sortie de "+ nom);
                console.log(" emission de sortie pour "+ nom);
                socket.emit('sortieS',nom);
            }
            socket.on('entreeC', data =>{
                numJoueur = data.numJoueur;
                console.log("confirmation de l'entre de "+ numJoueur);
                $("#btentree").toggle();                       //* pour hide le boutont entré dans la partie
                $("#listeJoueurs").text(data.nomsJoueurs);     //* pour actualiser la liste des joueurs de la partie
            });
            socket.on('entreeAutreJoueurC', data =>{
                console.log("le serveur confirme l'entrée de "+ data.nomJoueur);
                $('#listeJoueurs').text(data.nomsJoueurs);
                if(data.nomsJoueurs.length == 2){
                    $('#btentree').hide();
                }
            });
            socket.on('sortieC', data=>{
                nomJoueur = data;
                console.log("confirmation de la sortie de "+ nomJoueur);
                $("#btentree").toggle();
            });

            socket.on('message', data =>{
                console.log("erreur : "+data);
                console.dir("erreur : " +data); //console de l'ordi
            });

            function placerPion(){
                console.log("placerPion de la part de "+ numJoueur);
                var numHexagone = parseInt(d3.select(this).attr('id').substring(1));
                if(numJoueur != -1){
                    socket.emit('pionS', {'numHexagone': numHexagone, 'numJoueur':numJoueur});
                }
            }
            socket.on('pionC', data =>{
                console.log("       socket pion client "+ numJoueur);
                console.log('#h'+data.numHexagone);
                $('#h'+data.numHexagone).attr('fill', couleurs[data.numJoueur]);
            });
            

            window.addEventListener('load', () => { demandeJoueurs(); genereDamier(20, 11, 11); });
            function creeHexagone(rayon) {
                let points = new Array();
                for (var i = 0; i < 6; ++i) {
                    var angle = i * Math.PI / 3;
                    var x = Math.sin(angle) * rayon; 
                    var y = -Math.cos(angle) * rayon;
                    points.push([Math.round(x*100)/100, Math.round(y*100)/100]);
                }
                return points;
            }
            function genereDamier(rayon, nbLignes, nbColonnes) {
            distance = rayon - (Math.sin(1 * Math.PI / 3) * rayon);
            d3.select("#tablier").append("svg").attr("width", (nbLignes*2)*2*rayon).attr("height",nbLignes*2*rayon);
            var hexagone = creeHexagone(rayon);
            for (var ligne=0; ligne < nbLignes; ligne++) {
                for (var colonne=0; colonne < nbColonnes; colonne++) {
                    var d = ""; 
                    var x, y;
                    for (h in hexagone) {
                        x = hexagone[h][0]+(rayon-distance)*(2+ligne+2*colonne);
                        y = distance*2 + hexagone[h][1]+(rayon-distance*2)*(1+2*ligne);
                        if (h == 0){ 
                            d += "M"+x+","+y+" L"; 
                        }else{ 
                            d += x+","+y+" ";
                        }
                    } // gènère la forme
                    d += "Z";
                    d3.select("svg")
                    .append("path")
                    .attr("d", d).attr("stroke", "black").attr("fill", "white")
                    .attr("id", "h"+(ligne*11+colonne))
                    .on("click", placerPion);
                }
            }
        }
            window.addEventListener('load', () => { test(); } );
        </script>
    </head>
    <body> Un jeu de Hex 
        <br>
        Joueurs : <label id = "listeJoueurs"></label> 
        <br/>
        Votre nom <input id = "nom" type = "text"/>
        <button type = "button" onClick = "entrerDansLaPartie()" id="btentree">Entrer dans la partie</button>
        <button type = "button" onClick = "quitterLaPartie()" id="btquitee">Quitter la partie</button>
        <button type = "button" onClick = "reset()">reset</button>
        
        <div id="tablier"></div>
        <div id="popup">
            <form action="">
                <p>Un joueur est partie !!</p>
                <p>Voulez vous commencer une nouvelle partie ? ou continuelle celle la ?</p>
                <button type = "button" onClick = "softreset()">OUI</button>
                <button type = "button" onClick = "cacher()">NON</button>
            </form>
        </div>
    </body>
</html>
